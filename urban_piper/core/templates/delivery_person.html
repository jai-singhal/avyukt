{% extends "base.html" %}

{% block style %}
<style>
    .dp_task_pos {
        margin-top: 80px;
    }

    .dp_acceptedtask_pos {
        margin-top: 50px;
    }

    .btn {
        margin-left: 5px;
    }

</style>
{% endblock %}

{% block content %}
<div class="container h-60">
    <div class="col-12 dp_task_pos">
        <div class="card">
            <div class="card-header">
                <p class="text-muted">You will get task here.</p>
            </div>
            <div id="new_task_card">
                <div class='card'>
                    <div class="card-body">
                        <h6 class="text-danger">No new Task available for you right now</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 dp_acceptedtask_pos">
        <div class="card">
            <div class="card-header">
                <p class="text-muted">Your accepted tasks will be shown below.</p>
            </div>
            <div id="accepted_task_card">
                <div class='card w-100'>
                    <div class="card-body" id="task_accepted_body">
                        {% if non_pending_tasks %}
                        {% for task in non_pending_tasks %}
                        <div class='card' data-id="{{task.task__id}}">
                            <div class="card-body">
                                <h5 class="card-title">{{task.task__title}}</h5>
                                <p>Created at: {{task.task__creation_at| date:"d/m/Y g:i:s A"|lower}}</p>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-primary float-right task_completed">
                                    Complete
                                </button>
                                <button class="btn btn-danger float-right task_declined">
                                    Decline
                                </button>
                            </div>
                        </div>
                        {% endfor %}

                        {% else %}
                        <h6 class="text-danger" id="no_accepted_task">
                            You haven't accepted any Task
                        </h6>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}


{% block javascript %}
<script>
    function task_accepted(taskSocket, message) {
        taskSocket.send(JSON.stringify({
            "event": "TASK_ACCEPTED",
            "message": message
        }));
    }

    function task_completed(taskSocket, message) {
        taskSocket.send(JSON.stringify({
            "event": "TASK_COMPLETED",
            "message": message
        }));
    }


    function task_declined(taskSocket, message) {
        taskSocket.send(JSON.stringify({
            "event": "TASK_DECLINED",
            "message": message
        }));
    }


    function display_new_task(taskSocket, message) {
        let html_content;
        if (message) {
            html_content = `<div class = 'card'>
                <div class = "card-header">
                    <p>New Task Recieved:
                         Priority: <span class = "text-danger"> ${message["priority"]}</span>
                    </p>
                </div>
                <div class = "card-body">
                    <h5 class="card-title">${message["title"]}</h5>
                    <p>Created at: ${formatDate(new Date(message["creation_at"])) }</p>
                </div>
                <div class = "card-footer">
                    <button id = "task_accept" 
                        class = "btn btn-primary float-right">Accept</button>
                    <button id = "task_decline" 
                        class = "btn btn-danger float-right">Decline</button>
                </div>
            </div>`;
        } else {
            html_content = `
                <div class='card'>
                    <div class="card-body">
                        <h6 class="text-danger">No new Task available for you right now</h6>
                    </div>
                </div>
            `;
        }

        $("#new_task_card").html(html_content);
        $("#task_accept").click(function () {
            task_accepted(taskSocket, message);
        })
    }

    function display_accepted_task(taskSocket, message) {
        if ($("#no_accepted_task").length) {
            $("#no_accepted_task").remove();
        }

        $("#task_accepted_body").append(`
         <div class='card' data-id = ${message["id"]}>
            <div class="card-body" >
                <h5 class="card-title">${message["title"]}</h5>
                <p>Created at: ${formatDate(new Date(message["creation_at"]))}</p>
            </div>
            <div class="card-footer">
                <button class="btn btn-primary float-right task_completed">
                    Complete
                </button>
                <button class="btn btn-danger float-right task_declined">
                    Decline
                </button>
            </div>
        </div>
        `)
    }

    function remove_accepted_card(message) {
        $(`div.card[data-id=${message["id"]}]`).remove();
        if ($("#task_accepted_body").length) {
            $("#task_accepted_body").html(`
                <h6 class="text-danger" id = "no_accepted_task">
                    You haven't accepted any Task
                </h6>
            `);
        }
    }

    function connect() {
        var taskSocket = new WebSocket('ws://' + window.location.host + '/ws/task/');

        taskSocket.onopen = function open() {
            console.log('WebSockets connection created.');
            taskSocket.send(JSON.stringify({
                "event": "JOIN",
                "message": "dp"
            }));
        };

        taskSocket.onclose = function (e) {
            console.log('Socket is closed. Reconnect will be attempted in 1 second.', e.reason);
            setTimeout(function () {
                connect();
            }, 1000);
        };
        // Sending the info about the room
        taskSocket.onmessage = function (e) {
            let data = JSON.parse(e.data);
            data = data["payload"];
            let message = data['message'];
            let event = data["event"];
            console.log(event)
            switch (event) {
                case "NEW_TASK":
                    display_new_task(taskSocket, message);
                    break;
                case "TASK_ACCEPTED":
                    display_accepted_task(taskSocket, message);
                    break;
                case "TASK_PENDING":
                    alert(message)
                    break;
                case "TASK_COMPLETED_ACK":
                    remove_accepted_card(message);

                    break;
                case "TASK_DECLINED_ACK":
                    remove_accepted_card(message);

                    break;

                default:
                    console.log("No event")
            }
        };


        $(".task_completed").click(function () {
            let message = {
                id: $(this).parents(".card").attr("data-id"),
            }
            task_completed(taskSocket, message);
        })

        $(".task_declined").click(function () {
            let message = {
                id: $(this).parents(".card").attr("data-id"),
            }
            task_declined(taskSocket, message);
        })


        if (taskSocket.readyState == WebSocket.OPEN) {
            taskSocket.onopen();
        }
    }

    $(document).ready(function () {
        connect();
    });
</script>
{% endblock %}